const config = require("config");
const { GrpcServer, ServiceRegistry } = require("gioneco-grpc");

const register = new ServiceRegistry(config.get("consul"));

const ctrl = require("../controllers/index");
const baseLog = require("../log");

const grpcServer = new GrpcServer({
  protosDir: `${process.cwd()}/protos`,
  serviceFunctionMap: {
    //package.function
    "user.addUser"(call, callback) {
      const requestId = call.request.header.requestId || "";
      const logger = baseLog.getReqIdLogger(requestId, "biz");

      // logger.biz.info({
      console.log({
        message: ">>>>> request",
        data: call.request
      });

      //执行rpc方法
      ctrl.exec("user.addUser", call.request).then(resp => {
        logger.biz.info({
          message: "<<<<<< response",
          data: resp
        });

        callback(null, resp);
      }).catch(error => {
        logger.biz.error({
          message: "rpc process error",
          error: error.stack
        });
        callback(null, error);
      });
    }
  },
  registry: register,
  checkServiceHealthOptions: {
    checkServerPort: config.get("consulHealthPort")
  }
});

grpcServer.ready().catch(error => {
  console.error("rpc启动失败，error：", error.stack);
});
